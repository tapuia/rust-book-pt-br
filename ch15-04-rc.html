<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>ğŸ‡§ğŸ‡· Rc&lt;T&gt;, o Ponteiro Inteligente com Contagem de ReferÃªncias - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme;
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            document.querySelector('html').classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="ch01-00-introduction.html"><strong aria-hidden="true">1.</strong> ğŸ‡§ğŸ‡· IntroduÃ§Ã£o</a></li><li><ol class="section"><li><a href="ch01-01-installation.html"><strong aria-hidden="true">1.1.</strong> ğŸ‡§ğŸ‡· InstalaÃ§Ã£o</a></li><li><a href="ch01-02-hello-world.html"><strong aria-hidden="true">1.2.</strong> ğŸ‡§ğŸ‡· OlÃ¡, Mundo!</a></li></ol></li><li><a href="ch02-00-guessing-game-tutorial.html"><strong aria-hidden="true">2.</strong> ğŸ‡§ğŸ‡· Jogo de AdivinhaÃ§Ã£o</a></li><li><a href="ch03-00-common-programming-concepts.html"><strong aria-hidden="true">3.</strong> ğŸ‡§ğŸ‡· Conceitos Comuns de ProgramaÃ§Ã£o</a></li><li><ol class="section"><li><a href="ch03-01-variables-and-mutability.html"><strong aria-hidden="true">3.1.</strong> ğŸ‡§ğŸ‡· VariÃ¡veis e Mutabilidade</a></li><li><a href="ch03-02-data-types.html"><strong aria-hidden="true">3.2.</strong> ğŸ‡§ğŸ‡· Tipos de dados</a></li><li><a href="ch03-03-how-functions-work.html"><strong aria-hidden="true">3.3.</strong> ğŸ‡§ğŸ‡· FunÃ§Ãµes</a></li><li><a href="ch03-04-comments.html"><strong aria-hidden="true">3.4.</strong> ğŸ‡§ğŸ‡· ComentÃ¡rios</a></li><li><a href="ch03-05-control-flow.html"><strong aria-hidden="true">3.5.</strong> ğŸ‡§ğŸ‡· Controle de fluxo</a></li></ol></li><li><a href="ch04-00-understanding-ownership.html"><strong aria-hidden="true">4.</strong> ğŸ‡§ğŸ‡· Entendendo Ownership</a></li><li><ol class="section"><li><a href="ch04-01-what-is-ownership.html"><strong aria-hidden="true">4.1.</strong> ğŸ‡§ğŸ‡· O Que Ã‰ Ownership?</a></li><li><a href="ch04-02-references-and-borrowing.html"><strong aria-hidden="true">4.2.</strong> ğŸ‡§ğŸ‡· ReferÃªncias e Borrowing</a></li><li><a href="ch04-03-slices.html"><strong aria-hidden="true">4.3.</strong> ğŸ‡§ğŸ‡· Slices</a></li></ol></li><li><a href="ch05-00-structs.html"><strong aria-hidden="true">5.</strong> ğŸ‡§ğŸ‡· Structs</a></li><li><ol class="section"><li><a href="ch05-01-method-syntax.html"><strong aria-hidden="true">5.1.</strong> Method Syntax</a></li></ol></li><li><a href="ch06-00-enums.html"><strong aria-hidden="true">6.</strong> ğŸ‡§ğŸ‡· Enums e Casamento de PadrÃµes</a></li><li><ol class="section"><li><a href="ch06-01-defining-an-enum.html"><strong aria-hidden="true">6.1.</strong> ğŸ‡§ğŸ‡· Definindo uma Enum</a></li><li><a href="ch06-02-match.html"><strong aria-hidden="true">6.2.</strong> ğŸ‡§ğŸ‡· Operador match</a></li><li><a href="ch06-03-if-let.html"><strong aria-hidden="true">6.3.</strong> ğŸ‡§ğŸ‡· Controle de Fluxo Conciso com if let</a></li></ol></li><li><a href="ch07-00-modules.html"><strong aria-hidden="true">7.</strong> ğŸ‡§ğŸ‡· MÃ³dulos</a></li><li><ol class="section"><li><a href="ch07-01-mod-and-the-filesystem.html"><strong aria-hidden="true">7.1.</strong> ğŸ‡§ğŸ‡· mod e o Sistema de Arquivos</a></li><li><a href="ch07-02-controlling-visibility-with-pub.html"><strong aria-hidden="true">7.2.</strong> ğŸ‡§ğŸ‡· Controlando a Visibilidade com pub</a></li><li><a href="ch07-03-importing-names-with-use.html"><strong aria-hidden="true">7.3.</strong> ğŸ‡§ğŸ‡· Importando nomes com use</a></li></ol></li><li><a href="ch08-00-fundamental-collections.html"><strong aria-hidden="true">8.</strong> Fundamental Collections</a></li><li><ol class="section"><li><a href="ch08-01-vectors.html"><strong aria-hidden="true">8.1.</strong> ğŸ‡§ğŸ‡· Vetores</a></li><li><a href="ch08-02-strings.html"><strong aria-hidden="true">8.2.</strong> ğŸ‡§ğŸ‡· Strings</a></li><li><a href="ch08-03-hash-maps.html"><strong aria-hidden="true">8.3.</strong> ğŸ‡§ğŸ‡· Hash Maps</a></li></ol></li><li><a href="ch09-00-error-handling.html"><strong aria-hidden="true">9.</strong> ğŸ‡§ğŸ‡· Tratamento de Erros</a></li><li><ol class="section"><li><a href="ch09-01-unrecoverable-errors-with-panic.html"><strong aria-hidden="true">9.1.</strong> ğŸ‡§ğŸ‡· Erros IrrecuperÃ¡veis com panic!</a></li><li><a href="ch09-02-recoverable-errors-with-result.html"><strong aria-hidden="true">9.2.</strong> ğŸ‡§ğŸ‡· Erros recuperÃ¡veis com Result</a></li><li><a href="ch09-03-to-panic-or-not-to-panic.html"><strong aria-hidden="true">9.3.</strong> ğŸ‡§ğŸ‡· Entrar em panic! ou NÃ£o Entrar em panic!</a></li></ol></li><li><a href="ch10-00-generics.html"><strong aria-hidden="true">10.</strong> ğŸ‡§ğŸ‡· Tipos GenÃ©ricos, Traits, e Tempos de vida (Lifetimes)</a></li><li><ol class="section"><li><a href="ch10-01-syntax.html"><strong aria-hidden="true">10.1.</strong> ğŸ‡§ğŸ‡· Tipos GenÃ©ricos de Dados</a></li><li><a href="ch10-02-traits.html"><strong aria-hidden="true">10.2.</strong> ğŸ‡§ğŸ‡· Traits: Definindo Comportamento Compartilhado</a></li><li><a href="ch10-03-lifetime-syntax.html"><strong aria-hidden="true">10.3.</strong> ğŸ‡§ğŸ‡· Validating References with Lifetimes</a></li></ol></li><li><a href="ch11-00-testing.html"><strong aria-hidden="true">11.</strong> Testing</a></li><li><ol class="section"><li><a href="ch11-01-writing-tests.html"><strong aria-hidden="true">11.1.</strong> Writing tests</a></li><li><a href="ch11-02-running-tests.html"><strong aria-hidden="true">11.2.</strong> Running tests</a></li><li><a href="ch11-03-test-organization.html"><strong aria-hidden="true">11.3.</strong> Test Organization</a></li></ol></li><li><a href="ch12-00-an-io-project.html"><strong aria-hidden="true">12.</strong> An I/O Project</a></li><li><ol class="section"><li><a href="ch12-01-accepting-command-line-arguments.html"><strong aria-hidden="true">12.1.</strong> Accepting Command Line Arguments</a></li><li><a href="ch12-02-reading-a-file.html"><strong aria-hidden="true">12.2.</strong> Reading a File</a></li><li><a href="ch12-03-improving-error-handling-and-modularity.html"><strong aria-hidden="true">12.3.</strong> Improving Error Handling and Modularity</a></li><li><a href="ch12-04-testing-the-librarys-functionality.html"><strong aria-hidden="true">12.4.</strong> Testing the Library's Functionality</a></li><li><a href="ch12-05-working-with-environment-variables.html"><strong aria-hidden="true">12.5.</strong> Working with Environment Variables</a></li><li><a href="ch12-06-writing-to-stderr-instead-of-stdout.html"><strong aria-hidden="true">12.6.</strong> Writing to stderr instead of stdout</a></li></ol></li><li><a href="ch13-00-functional-features.html"><strong aria-hidden="true">13.</strong> Functional Language Features in Rust</a></li><li><ol class="section"><li><a href="ch13-01-closures.html"><strong aria-hidden="true">13.1.</strong> Closures</a></li><li><a href="ch13-02-iterators.html"><strong aria-hidden="true">13.2.</strong> Iterators</a></li><li><a href="ch13-03-improving-our-io-project.html"><strong aria-hidden="true">13.3.</strong> Improving our I/O Project</a></li><li><a href="ch13-04-performance.html"><strong aria-hidden="true">13.4.</strong> Performance</a></li></ol></li><li><a href="ch14-00-more-about-cargo.html"><strong aria-hidden="true">14.</strong> More about Cargo and Crates.io</a></li><li><ol class="section"><li><a href="ch14-01-release-profiles.html"><strong aria-hidden="true">14.1.</strong> Release Profiles</a></li><li><a href="ch14-02-publishing-to-crates-io.html"><strong aria-hidden="true">14.2.</strong> Publishing a Crate to Crates.io</a></li><li><a href="ch14-03-cargo-workspaces.html"><strong aria-hidden="true">14.3.</strong> Cargo Workspaces</a></li><li><a href="ch14-04-installing-binaries.html"><strong aria-hidden="true">14.4.</strong> Installing Binaries from Crates.io with cargo install</a></li><li><a href="ch14-05-extending-cargo.html"><strong aria-hidden="true">14.5.</strong> Extending Cargo with Custom Commands</a></li></ol></li><li><a href="ch15-00-smart-pointers.html"><strong aria-hidden="true">15.</strong> ğŸ‡§ğŸ‡· Ponteiros Inteligentes (Smart Pointers)</a></li><li><ol class="section"><li><a href="ch15-01-box.html"><strong aria-hidden="true">15.1.</strong> ğŸ‡§ğŸ‡· Box<T> Aponta para Dados no Heap e Tem Tamanho Conhecido</a></li><li><a href="ch15-02-deref.html"><strong aria-hidden="true">15.2.</strong> ğŸ‡§ğŸ‡· Tratando Ponteiros Inteligentes como ReferÃªncias Normais com a Trait Deref</a></li><li><a href="ch15-03-drop.html"><strong aria-hidden="true">15.3.</strong> ğŸ‡§ğŸ‡· A Trait Drop Roda CÃ³digo durante a Limpeza</a></li><li><a href="ch15-04-rc.html" class="active"><strong aria-hidden="true">15.4.</strong> ğŸ‡§ğŸ‡· Rc<T>, o Ponteiro Inteligente com Contagem de ReferÃªncias</a></li><li><a href="ch15-05-interior-mutability.html"><strong aria-hidden="true">15.5.</strong> ğŸ‡§ğŸ‡· RefCell<T> e a Pattern de Mutabilidade Interior</a></li><li><a href="ch15-06-reference-cycles.html"><strong aria-hidden="true">15.6.</strong> ğŸ‡§ğŸ‡· Ciclos de ReferÃªncias Podem Vazar MemÃ³ria</a></li></ol></li><li><a href="ch16-00-concurrency.html"><strong aria-hidden="true">16.</strong> Concurrency</a></li><li><a href="ch17-00-oop.html"><strong aria-hidden="true">17.</strong> ğŸ‡§ğŸ‡· Rust Ã© uma linguagem orientada a objetos?</a></li><li><ol class="section"><li><a href="ch17-01-what-is-oo.html"><strong aria-hidden="true">17.1.</strong> ğŸ‡§ğŸ‡· O que significa orientado a objetos?</a></li><li><a href="ch17-02-trait-objects.html"><strong aria-hidden="true">17.2.</strong> ğŸ‡§ğŸ‡· Usando objetos trait que permitem valores de tipos diferentes</a></li><li><a href="ch17-03-oo-design-patterns.html"><strong aria-hidden="true">17.3.</strong> ğŸ‡§ğŸ‡· Implementando um padrÃ£o de projeto orientado a objetos</a></li></ol></li><li><a href="ch18-00-patterns.html"><strong aria-hidden="true">18.</strong> Patterns</a></li><li><a href="ch19-00-more-lifetimes.html"><strong aria-hidden="true">19.</strong> More Lifetimes</a></li><li><a href="ch20-00-advanced-types.html"><strong aria-hidden="true">20.</strong> Advanced Type System Features</a></li><li><a href="appendix-00.html"><strong aria-hidden="true">21.</strong> Appendix</a></li><li><ol class="section"><li><a href="appendix-01-keywords.html"><strong aria-hidden="true">21.1.</strong> Keywords</a></li><li><a href="appendix-02-operators.html"><strong aria-hidden="true">21.2.</strong> Operators</a></li><li><a href="appendix-03-derivable-traits.html"><strong aria-hidden="true">21.3.</strong> Derivable Traits</a></li><li><a href="appendix-04-nightly-rust.html"><strong aria-hidden="true">21.4.</strong> Nightly Rust</a></li><li><a href="appendix-05-macros.html"><strong aria-hidden="true">21.5.</strong> Macros</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="submenu">
                                <li><button class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li><button class="theme" id="rust">Rust</button></li>
                                <li><button class="theme" id="coal">Coal</button></li>
                                <li><button class="theme" id="navy">Navy</button></li>
                                <li><button class="theme" id="ayu">Ayu</button></li>
                            </ul>
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="ch15-04-rc.html#rct-o-ponteiro-inteligente-com-contagem-de-referÃªncias" id="rct-o-ponteiro-inteligente-com-contagem-de-referÃªncias"><h2><code>Rc&lt;T&gt;</code>, o Ponteiro Inteligente com Contagem de ReferÃªncias</h2></a>
<p>Na maioria dos casos, a posse Ã© clara: vocÃª sabe exatamente qual variÃ¡vel tem
posse de um dado valor. Contudo, hÃ¡ casos onde um Ãºnico valor pode ter mÃºltiplos
possuidores. Por exemplo, em uma estrutura de dados em grafo, mÃºltiplas arestas
podem apontar para o mesmo vÃ©rtice, e esse vÃ©rtice Ã© conceitualmente possuÃ­do
por todas as arestas que apontam para ele. Um vÃ©rtice nÃ£o deveria ser liberado a
nÃ£o ser que ele nÃ£o tenha mais arestas apontando para ele.</p>
<p>Para permitir posse mÃºltipla, o Rust tem um tipo chamado <code>Rc&lt;T&gt;</code>. Seu nome Ã© uma
abreviaÃ§Ã£o para <em>reference counting</em> (<em>contagem de referÃªncias</em>) que, como o
nome diz, mantÃ©m registro do nÃºmero de referÃªncias a um valor para saber se ele
ainda estÃ¡ em uso ou nÃ£o. Se hÃ¡ zero referÃªncias a um valor, ele pode ser
liberado sem que nenhuma referÃªncia se torne invÃ¡lida.</p>
<p>Imagine o <code>Rc&lt;T&gt;</code> como uma TV numa sala de famÃ­lia. Quando uma pessoa entra para
assistir Ã  TV, ela a liga. Outros podem entrar na sala e assistir Ã  TV. Quando a
Ãºltima pessoa sai da sala, ela desliga a TV porque essa nÃ£o estÃ¡ mais em uso. Se
alguÃ©m desligasse a TV enquanto outros ainda estÃ£o assistindo, haveria revolta
entre os telespectadores restantes!</p>
<p>NÃ³s usamos o tipo <code>Rc&lt;T&gt;</code> quando queremos alocar algum dado no heap para que
mÃºltiplas partes do nosso programa o leiam, e nÃ£o conseguimos determinar em
tempo de compilaÃ§Ã£o qual parte irÃ¡ terminar de usar o dado por Ãºltimo. Se
soubÃ©ssemos qual parte terminaria por Ãºltimo, poderÃ­amos simplesmente tornar
aquela parte a possuidora do dado e as regras normais de posse aplicadas em
tempo de compilaÃ§Ã£o teriam efeito.</p>
<p>Note que o <code>Rc&lt;T&gt;</code> serve apenas para cenÃ¡rios de thread Ãºnica. Quando
discutirmos concorrÃªncia no CapÃ­tulo 16, cobriremos como fazer contagem de
referÃªncias em programas com mÃºltiplas threads.</p>
<a class="header" href="ch15-04-rc.html#usando-rct-para-compartilhar-dados" id="usando-rct-para-compartilhar-dados"><h3>Usando <code>Rc&lt;T&gt;</code> para Compartilhar Dados</h3></a>
<p>Vamos retornar ao nosso exemplo de <em>cons list</em> da Listagem 15-5. Lembre-se de
que a definimos usando o <code>Box&lt;T&gt;</code>. Desta vez, vamos criar duas listas que
compartilham ambas a posse de uma terceira lista, o que conceitualmente vai se
parecer com a Figura 15-3:</p>
<p><img alt="Duas listas que compartilham a posse de uma terceira lista" src="img/trpl15-03.svg" class="center" /></p>
<p><span class="caption">Figura 15-3: Duas listas, <code>b</code> e <code>c</code>, compartilhando posse
de uma terceira lista, <code>a</code></span></p>
<p>Vamos criar a lista <code>a</code> que contÃ©m 5 e depois 10. EntÃ£o criaremos mais duas
listas: <code>b</code>, que comeÃ§a com 3 e <code>c</code>, que comeÃ§a com 4. Ambas as listas <code>b</code> e <code>c</code>
irÃ£o entÃ£o continuar na lista <code>a</code> contendo 5 e 10. Em outras palavras, ambas as
listas irÃ£o compartilhar a primeira lista contendo 5 e 10.</p>
<p>Tentar implementar esse cenÃ¡rio usando nossa definiÃ§Ã£o de <code>List</code> com <code>Box&lt;T&gt;</code>
nÃ£o irÃ¡ funcionar, como mostra a Listagem 15-17:</p>
<p><span class="filename">Arquivo: src/main.rs</span></p>
<pre><code class="language-rust ignore">enum List {
    Cons(i32, Box&lt;List&gt;),
    Nil,
}

use List::{Cons, Nil};

fn main() {
    let a = Cons(5,
        Box::new(Cons(10,
            Box::new(Nil))));
    let b = Cons(3, Box::new(a));
    let c = Cons(4, Box::new(a));
}
</code></pre>
<p><span class="caption">Listagem 15-17: Demonstrando que nÃ£o Ã© possÃ­vel termos
duas listas usando <code>Box&lt;T&gt;</code> que tentam compartilhar posse de uma terceira
lista</span></p>
<p>Quando compilamos esse cÃ³digo, recebemos este erro:</p>
<pre><code class="language-text">erro[E0382]: uso de valor movido: `a`
  --&gt; src/main.rs:13:30
   |
12 |     let b = Cons(3, Box::new(a));
   |                              - valor movido para cÃ¡
13 |     let c = Cons(4, Box::new(a));
   |                              ^ valor usado aqui depois de movido
   |
   = nota: o valor Ã© movido porque `a` tem tipo `List`, que nÃ£o implementa
   a trait `Copy`
</code></pre>
<p>As variantes <code>Cons</code> tÃªm posse dos dados que elas contÃªm, entÃ£o quando criamos a
lista <code>b</code>, <code>a</code> Ã© movida para dentro de <code>b</code>, e <code>b</code> toma posse de <code>a</code>. EntÃ£o,
quando tentamos usar <code>a</code> de novo na criaÃ§Ã£o de <code>c</code>, nÃ£o somos permitidos porque
<code>a</code> foi movida.</p>
<p>PoderÃ­amos mudar a definiÃ§Ã£o de <code>Cons</code> para guardar referÃªncias, mas aÃ­ terÃ­amos
que especificar parÃ¢metros de tempo de vida (<em>lifetime parameters</em>). Fazendo
isso, estarÃ­amos especificando que cada elemento da lista devesse viver por pelo
menos tanto tempo quanto a lista inteira. O <em>verificador de emprÃ©stimo</em> (<em>borrow
checker</em>) nÃ£o nos deixaria compilar <code>let a = Cons(10, &amp;Nil);</code>, por exemplo,
porque o valor temporÃ¡rio <code>Nil</code> seria destruÃ­do antes que <code>a</code> pudesse receber
uma referÃªncia a ele.</p>
<p>Em vez disso, vamos mudar nossa definiÃ§Ã£o de <code>List</code> para usar o <code>Rc&lt;T&gt;</code> no lugar
do <code>Box&lt;T&gt;</code>, como mostra a Listagem 15-18. Cada variante <code>Cons</code> agora vai conter
um valor e um <code>Rc&lt;T&gt;</code> apontando para uma <code>List</code>. Quando criarmos <code>b</code>, em vez de
tomar posse de <code>a</code>, iremos clonar o <code>Rc&lt;List&gt;</code> que <code>a</code> estÃ¡ segurando, o que
aumenta o nÃºmero de referÃªncias de uma para duas e permite com que <code>a</code> e
<code>b</code>compartilhem posse dos dados naquele <code>Rc&lt;List&gt;</code>. TambÃ©m vamos clonar <code>a</code>
quando criarmos <code>c</code>, o que aumenta o nÃºmero de referÃªncias de duas para trÃªs.
Cada vez que chamarmos <code>Rc::clone</code>, a contagem de referÃªncias ao valor dentro do
<code>Rc&lt;List&gt;</code> irÃ¡ aumentar, e ele nÃ£o serÃ¡ liberado atÃ© que haja zero referÃªncias a
ele:</p>
<p><span class="filename">Arquivo: src/main.rs</span></p>
<pre><pre class="playpen"><code class="language-rust">enum List {
    Cons(i32, Rc&lt;List&gt;),
    Nil,
}

use List::{Cons, Nil};
use std::rc::Rc;

fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    let b = Cons(3, Rc::clone(&amp;a));
    let c = Cons(4, Rc::clone(&amp;a));
}
</code></pre></pre>
<p><span class="caption">Listagem 15-18: Uma definiÃ§Ã£o de <code>List</code> que usa o
<code>Rc&lt;T&gt;</code></span></p>
<p>Precisamos adicionar uma declaraÃ§Ã£o <code>use</code> para trazer o <code>Rc&lt;T&gt;</code> ao escopo porque
ele nÃ£o estÃ¡ no prelÃºdio. Na <code>main</code>, criamos a lista contendo 5 e 10 e a
armazenamos em um novo <code>Rc&lt;List&gt;</code> em <code>a</code>. EntÃ£o quando criamos <code>b</code> e <code>c</code>,
chamamos a funÃ§Ã£o <code>Rc::clone</code> e passamos uma referÃªncia ao <code>Rc&lt;List&gt;</code> em <code>a</code>
como argumento.</p>
<p>PoderÃ­amos ter chamado <code>a.clone()</code> em vez de <code>Rc::clone(&amp;a)</code>, mas a convenÃ§Ã£o do
Rust Ã© usar <code>Rc::clone</code> neste caso. A implementaÃ§Ã£o de <code>Rc::clone</code> nÃ£o faz uma
cÃ³pia profunda de todos os dados como faz a implementaÃ§Ã£o de <code>clone</code> da maioria
dos tipos. A chamada a <code>Rc::clone</code> apenas incrementa a contagem de referÃªncias,
o que nÃ£o leva muito tempo. CÃ³pias profundas de dados podem levar muito tempo.
Usando <code>Rc::clone</code> para a contagem de referÃªncias, podemos distinguir
visualmente entre os clones de cÃ³pia profunda e os clones que incrementam a
contagem de referÃªncias. Quando estivermos procurando problemas de desempenho no
cÃ³digo, precisamos apenas considerar os clones de cÃ³pia profunda e podemos
ignorar as chamadas a <code>Rc::clone</code>.</p>
<a class="header" href="ch15-04-rc.html#clonar-um-rct-aumenta-a-contagem-de-referÃªncias" id="clonar-um-rct-aumenta-a-contagem-de-referÃªncias"><h3>Clonar um <code>Rc&lt;T&gt;</code> Aumenta a Contagem de ReferÃªncias</h3></a>
<p>Vamos mudar nosso exemplo de trabalho na Listagem 15-18 para podermos ver a
contagem de referÃªncias mudando conforme criamos e destruÃ­mos referÃªncias ao
<code>Rc&lt;List&gt;</code> em <code>a</code>.</p>
<p>Na Listagem 15-19, vamos mudar a <code>main</code> para que tenha um escopo interno em
volta da lista <code>c</code>; assim poderemos ver como a contagem de referÃªncias muda
quando <code>c</code> sai de escopo. Em cada ponto do programa onde a contagem de
referÃªncias muda, iremos imprimir seu valor, que podemos obter chamando a funÃ§Ã£o
<code>Rc::strong_count</code>. Essa funÃ§Ã£o se chama <code>strong_count</code> (<em>contagem das
referÃªncias fortes</em>) em vez de <code>count</code> (<em>contagem</em>) porque o tipo <code>Rc&lt;T&gt;</code> tambÃ©m
tem uma <code>weak_count</code> (<em>contagem das referÃªncias fracas</em>); veremos para que a
<code>weak_count</code> Ã© usada na seÃ§Ã£o &quot;Evitando Ciclos de ReferÃªncias&quot;.</p>
<p><span class="filename">Arquivo: src/main.rs</span></p>
<pre><pre class="playpen"><code class="language-rust"># enum List {
#     Cons(i32, Rc&lt;List&gt;),
#     Nil,
# }
#
# use List::{Cons, Nil};
# use std::rc::Rc;
#
fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    println!(&quot;contagem depois de criar a = {}&quot;, Rc::strong_count(&amp;a));
    let b = Cons(3, Rc::clone(&amp;a));
    println!(&quot;contagem depois de criar b = {}&quot;, Rc::strong_count(&amp;a));
    {
        let c = Cons(4, Rc::clone(&amp;a));
        println!(&quot;contagem depois de criar c = {}&quot;, Rc::strong_count(&amp;a));
    }
    println!(&quot;contagem depois que c sai de escopo = {}&quot;, Rc::strong_count(&amp;a));
}
</code></pre></pre>
<p><span class="caption">Listagem 15-19: Imprimindo a contagem de
referÃªncias</span></p>
<p>Esse cÃ³digo imprime o seguinte:</p>
<pre><code class="language-text">contagem depois de criar a = 1
contagem depois de criar b = 2
contagem depois de criar c = 3
contagem depois que c sai de escopo = 2
</code></pre>
<p>Podemos ver que o <code>Rc&lt;List&gt;</code> em <code>a</code> tem uma contagem de referÃªncias inicial de
um; depois, cada vez que chamamos <code>clone</code>, a contagem aumenta em um. Quando <code>c</code>
sai de escopo, a contagem diminui em um. NÃ³s nÃ£o temos que chamar uma funÃ§Ã£o
para decrementar a contagem de referÃªncias como temos que fazer com a
<code>Rc::clone</code> para incrementÃ¡-la: a implementaÃ§Ã£o da trait <code>Drop</code> diminui a
contagem automaticamente quando um valor <code>Rc&lt;T&gt;</code> sai de escopo.</p>
<p>O que nÃ£o conseguimos ver nesse exemplo Ã© que quando <code>b</code> e depois <code>a</code> saem de
escopo no final da <code>main</code>, a contagem se torna 0, e o <code>Rc&lt;List&gt;</code> Ã©
liberado por completo nesse ponto. O uso do <code>Rc&lt;T&gt;</code> permite que um Ãºnico valor
tenha mÃºltiplos possuidores, e a contagem garante que o valor permaneÃ§a vÃ¡lido
enquanto algum dos possuidores ainda existir.</p>
<p>Por funcionar com referÃªncias imutÃ¡veis, o <code>Rc&lt;T&gt;</code> nos permite compartilhar
dados entre diversas partes do nosso programa <em>apenas para leitura</em>. Se o
<code>Rc&lt;T&gt;</code> nos deixasse ter mÃºltiplas referÃªncias mutÃ¡veis tambÃ©m, nÃ³s poderÃ­amos
violar uma das regras de emprÃ©stimo discutidas no CapÃ­tulo 4: mÃºltiplos
emprÃ©stimos mutÃ¡veis do mesmo lugar podem causar corridas de dados (<em>data
races</em>) e inconsistÃªncias. Mas conseguir modificar dados Ã© muito Ãºtil! Na
prÃ³xima seÃ§Ã£o, discutiremos a pattern de mutabilidade interior (<em>interior
mutability</em>) e o tipo <code>RefCell&lt;T&gt;</code> que podemos usar junto com um <code>Rc&lt;T&gt;</code> para
trabalhar com essa restriÃ§Ã£o de imutabilidade.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="ch15-03-drop.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ch15-05-interior-mutability.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="ch15-03-drop.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="ch15-05-interior-mutability.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if (getComputedStyle(document.querySelector(".fa")).fontFamily !== "FontAwesome") {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '_FontAwesome/css/font-awesome.css';
                document.head.insertBefore(link, document.head.firstChild)
            }
        </script>

        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
